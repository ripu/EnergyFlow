<!doctype html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <script src="logger.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Flow Inverter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #eef1f6;
      --panel: #ffffff;
      --panel-soft: #f7f9fc;
      --ink: #1e2a3b;
      --muted: #7a8699;
      --accent: #2bb3b1;
      --accent-strong: #1a8c8b;
      --line: #d9e1ec;
      --warning: #f7c76b;
      --danger: #ef7b7b;
      --shadow: 0 24px 60px rgba(17, 24, 39, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Sora", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(120% 120% at 10% 10%, #f8faff 0%, #eef1f6 46%, #e8eef4 100%);
      min-height: 100vh;
    }

    .shell {
      width: min(1200px, 100%);
      margin: 0 auto;
      padding: 28px 20px 40px;
      display: grid;
      gap: 22px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 24px;
      flex-wrap: wrap;
    }

    .title-block {
      display: grid;
      gap: 6px;
    }

    .eyebrow {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--muted);
    }

    h1 {
      font-size: 30px;
      margin: 0;
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-size: 14px;
      color: var(--muted);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 18px;
      flex-wrap: wrap;
    }

    .weather-card {
      background: var(--panel);
      border-radius: 18px;
      padding: 12px 16px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 8px;
      min-width: 220px;
    }

    .weather-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .weather-icon {
      width: 34px;
      height: 34px;
      display: grid;
      place-items: center;
      background: #fff3d4;
      border-radius: 12px;
      color: #f4a12e;
    }

    .weather-icon.sunny {
      background: #fff3d4;
      color: #f4a12e;
    }

    .weather-icon.cloudy {
      background: #e9eef7;
      color: #7b8aa1;
    }

    .weather-icon.fog {
      background: #e8edf5;
      color: #8996aa;
    }

    .weather-icon.rain {
      background: #e6f0ff;
      color: #4c7fd6;
    }

    .weather-icon.storm {
      background: #efe7ff;
      color: #6c54d8;
    }

    .weather-icon.snow {
      background: #eef4ff;
      color: #8ab5ff;
    }

    .temp-range {
      font-size: 18px;
      font-weight: 600;
    }

    .sun-line {
      font-size: 12px;
      color: var(--muted);
    }

    .date-line {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .weather-desc {
      font-size: 12px;
      color: var(--muted);
    }

    .forecast {
      display: flex;
      gap: 10px;
    }

    .forecast-item {
      background: var(--panel);
      border-radius: 14px;
      padding: 10px 12px;
      display: grid;
      gap: 6px;
      justify-items: center;
      min-width: 60px;
      box-shadow: var(--shadow);
      font-size: 12px;
      color: var(--muted);
    }

    .flow-card {
      background: var(--panel);
      border-radius: 26px;
      padding: 20px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 16px;
    }

    .flow-board {
      position: relative;
      border-radius: 24px;
      background: var(--panel-soft);
      overflow: hidden;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      grid-template-areas:
        "solar inverter battery"
        "grid meter home";
      gap: 18px;
      padding: 24px;
    }

    .flow-board::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(60deg, rgba(140, 151, 170, 0.18) 0 1px, transparent 1px 32px),
        repeating-linear-gradient(-60deg, rgba(140, 151, 170, 0.18) 0 1px, transparent 1px 32px);
      opacity: 0.35;
      pointer-events: none;
      z-index: 0;
    }

    .flow-board::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 60% 25%, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0) 55%);
      pointer-events: none;
      z-index: 1;
    }

    .connector {
      display: none;
    }

    .connector::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.85) 50%, transparent 100%);
      background-size: 200% 100%;
      animation: flow 3.2s linear infinite;
      border-radius: 999px;
    }

    .connector.idle {
      opacity: 0.25;
    }

    .connector.flow-out::after {
      animation-direction: reverse;
    }

    @keyframes flow {
      0% {
        background-position: 0% 0%;
      }

      100% {
        background-position: -200% 0%;
      }
    }

    .node {
      position: relative;
      width: auto;
      display: grid;
      align-content: start;
      gap: 10px;
      text-align: left;
      padding: 16px;
      border-radius: 20px;
      background: #ffffff;
      border: 1px solid #eef2f7;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
      z-index: 3;
    }

    .node .tile {
      width: 100%;
      height: 120px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #eef2f7;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
      position: relative;
    }

    .node .tile::before {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: 14px;
      background: linear-gradient(145deg, #ffffff, #eef3f8);
    }

    .node .tile::after {
      content: "";
      position: absolute;
      bottom: -14px;
      left: 14px;
      width: calc(100% - 28px);
      height: 20px;
      background: rgba(15, 23, 42, 0.1);
      filter: blur(12px);
      border-radius: 50%;
      z-index: -1;
    }

    .node .icon {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: var(--node-accent, #8aa0b8);
    }

    .node .icon svg {
      width: 96px;
      height: 72px;
    }

    .node-label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    .node-value {
      font-size: clamp(28px, 3.2vw, 40px);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .node-sub {
      font-size: 15px;
      color: var(--muted);
    }

    .node-runtime {
      font-size: clamp(14px, 1.6vw, 18px);
      font-weight: 600;
      color: var(--accent-strong);
    }

    .node.solar {
      grid-area: solar;
      --node-accent: #f2a534;
    }

    .node.inverter {
      grid-area: inverter;
      --node-accent: #6aa6ff;
    }

    .node.battery {
      grid-area: battery;
      --node-accent: #47b88f;
    }

    .node.home {
      grid-area: home;
      --node-accent: #8a7df2;
    }

    .node.grid {
      grid-area: grid;
      --node-accent: #94a3b8;
    }

    .node.meter {
      grid-area: meter;
      align-self: center;
      justify-self: center;
      max-width: 220px;
      padding: 12px;
    }

    .node.meter .tile {
      height: 90px;
    }

    .node.meter .icon svg {
      width: 66px;
      height: 50px;
    }

    .control-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .status-group {
      display: grid;
      gap: 6px;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(43, 179, 177, 0.12);
      color: var(--accent-strong);
      width: fit-content;
    }

    .status-chip.warning {
      background: rgba(247, 199, 107, 0.25);
      color: #b46b00;
    }

    .status-chip.danger {
      background: rgba(239, 123, 123, 0.2);
      color: #b14242;
    }

    .api-status {
      font-size: 12px;
      color: var(--muted);
    }

    .control-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(120deg, #2bb3b1, #67d0c8);
      color: #0d2626;
      box-shadow: 0 12px 30px rgba(43, 179, 177, 0.25);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(43, 179, 177, 0.32);
    }

    button.ghost {
      background: #f3f6fb;
      color: var(--ink);
      box-shadow: inset 0 0 0 1px #e2e8f0;
    }

    .last-update {
      font-size: 12px;
      color: var(--muted);
    }

    details {
      background: var(--panel);
      border-radius: 22px;
      padding: 16px 20px;
      box-shadow: var(--shadow);
    }

    summary {
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
    }

    .details-grid {
      margin-top: 16px;
      display: grid;
      gap: 16px;
    }

    .input-panel textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: #fbfcff;
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.4;
      color: #1f2937;
    }

    .actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 480px;
    }

    th,
    td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #edf2f7;
    }

    th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }

    td.label {
      color: var(--muted);
      font-size: 13px;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 980px) {
      .flow-board {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-template-areas:
          "solar inverter"
          "battery home"
          "grid meter";
      }
    }

    @media (max-width: 640px) {
      .flow-board {
        grid-template-columns: 1fr;
        grid-template-areas:
          "solar"
          "inverter"
          "battery"
          "home"
          "grid"
          "meter";
      }

      .control-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .control-actions {
        width: 100%;
        justify-content: space-between;
      }

      .node.meter {
        order: 6;
      }
    }
  </style>
</head>

<body>
  <div class="shell">
    <header class="topbar">
      <div class="title-block">
        <div class="eyebrow">Live inverter</div>
        <h1>Energy flow</h1>
        <div class="subtitle">Dashboard in tempo reale</div>
      </div>
      <div class="topbar-right">
        <div class="weather-card">
          <div class="weather-main">
            <div class="weather-icon sunny" id="weatherIcon">
              <svg viewBox="0 0 32 32" fill="none" aria-hidden="true">
                <circle cx="16" cy="16" r="6" fill="currentColor"></circle>
                <path d="M16 4v4M16 24v4M4 16h4M24 16h4M7.2 7.2l2.8 2.8M22 22l2.8 2.8M7.2 24.8l2.8-2.8M22 10l2.8-2.8"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              </svg>
            </div>
            <div>
              <div class="sun-line" id="sunLine">Alba --:-- · Tramonto --:--</div>
              <div class="temp-range" id="tempRange">--&deg;C - --&deg;C</div>
              <div class="date-line" id="dateLine">--</div>
              <div class="weather-desc" id="weatherDesc">--</div>
            </div>
          </div>
        </div>
        <div class="forecast">
          <div class="forecast-item">
            <div id="forecastDate1">--/--</div>
            <div id="forecastTemp1">--&deg;C</div>
          </div>
          <div class="forecast-item">
            <div id="forecastDate2">--/--</div>
            <div id="forecastTemp2">--&deg;C</div>
          </div>
        </div>
      </div>
    </header>

    <section class="flow-card">
      <div class="flow-board">
        <div class="connector line-solar idle" id="lineSolar"></div>
        <div class="connector line-battery idle" id="lineBattery"></div>
        <div class="connector line-home idle" id="lineHome"></div>
        <div class="connector line-grid idle" id="lineGrid"></div>
        <div class="connector line-meter idle" id="lineMeter"></div>

        <div class="node solar">
          <div class="tile">
            <div class="icon">
              <svg viewBox="0 0 80 60" fill="none" aria-hidden="true">
                <circle cx="62" cy="12" r="7" fill="currentColor" opacity="0.85"></circle>
                <rect x="10" y="28" width="22" height="12" rx="2" fill="currentColor" opacity="0.25"></rect>
                <rect x="36" y="28" width="22" height="12" rx="2" fill="currentColor" opacity="0.25"></rect>
                <path d="M10 28l6-10h20l6 10" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path>
                <path d="M36 28l6-10h20l6 10" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path>
              </svg>
            </div>
          </div>
          <div class="node-label">Solar</div>
          <div class="node-value" id="solarPower">--</div>
        </div>

        <div class="node inverter">
          <div class="tile">
            <div class="icon">
              <svg viewBox="0 0 60 70" fill="none" aria-hidden="true">
                <rect x="14" y="8" width="32" height="48" rx="6" fill="currentColor" opacity="0.2"></rect>
                <rect x="14" y="8" width="32" height="48" rx="6" stroke="currentColor" stroke-width="2"></rect>
                <rect x="22" y="18" width="16" height="10" rx="2" fill="currentColor" opacity="0.6"></rect>
                <circle cx="30" cy="44" r="3" fill="currentColor"></circle>
                <rect x="24" y="56" width="12" height="6" rx="3" fill="currentColor" opacity="0.4"></rect>
              </svg>
            </div>
          </div>
          <div class="node-label">Inverter</div>
          <div class="node-value" id="inverterPower">--</div>
        </div>

        <div class="node battery">
          <div class="tile">
            <div class="icon">
              <svg viewBox="0 0 70 60" fill="none" aria-hidden="true">
                <rect x="8" y="16" width="48" height="28" rx="6" fill="currentColor" opacity="0.2"></rect>
                <rect x="8" y="16" width="48" height="28" rx="6" stroke="currentColor" stroke-width="2"></rect>
                <rect x="56" y="24" width="6" height="12" rx="2" fill="currentColor"></rect>
                <rect x="14" y="22" width="34" height="16" rx="4" fill="currentColor" opacity="0.6"></rect>
              </svg>
            </div>
          </div>
          <div class="node-label">Battery</div>
          <div class="node-value" id="batteryPower">--</div>
          <div class="node-runtime" id="batteryRuntime">Autonomia: --</div>
          <div class="node-sub" id="batterySunWindow">FV: --</div>
        </div>

        <div class="node home">
          <div class="tile">
            <div class="icon">
              <svg viewBox="0 0 70 60" fill="none" aria-hidden="true">
                <path d="M12 30L35 12L58 30" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path>
                <rect x="18" y="30" width="34" height="20" rx="4" fill="currentColor" opacity="0.2"></rect>
                <rect x="18" y="30" width="34" height="20" rx="4" stroke="currentColor" stroke-width="2"></rect>
                <rect x="30" y="36" width="10" height="14" rx="2" fill="currentColor" opacity="0.6"></rect>
              </svg>
            </div>
          </div>
          <div class="node-label">Home</div>
          <div class="node-value" id="homePower">--</div>
        </div>

        <div class="node grid">
          <div class="tile">
            <div class="icon">
              <svg viewBox="0 0 70 70" fill="none" aria-hidden="true">
                <path d="M35 8L22 56H48L35 8Z" fill="currentColor" opacity="0.18"></path>
                <path d="M35 8L22 56H48L35 8Z" stroke="currentColor" stroke-width="2"></path>
                <path d="M20 30H50M18 40H52" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                <path d="M28 56L22 64M42 56L48 64" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
              </svg>
            </div>
          </div>
          <div class="node-label">Grid</div>
          <div class="node-value" id="gridPower">--</div>
          <div class="node-sub" id="gridDirection">Standby</div>
        </div>

        <div class="node meter">
          <div class="tile">
            <div class="icon">
              <svg viewBox="0 0 60 50" fill="none" aria-hidden="true">
                <rect x="12" y="8" width="36" height="28" rx="6" fill="currentColor" opacity="0.25"></rect>
                <rect x="12" y="8" width="36" height="28" rx="6" stroke="currentColor" stroke-width="2"></rect>
                <path d="M30 14l-6 10h8l-4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="control-bar">
        <div class="status-group">
          <div class="status-chip" id="statusChip">Attesa dati</div>
          <div class="api-status" id="apiStatus">API HTTP: avvia <strong>python3 invert.py --serve</strong> (default
            http://localhost:8000/data)</div>
        </div>
        <div class="control-actions">
          <button id="viewToggleBtn" style="background: linear-gradient(120deg, #8b5cf6, #a78bfa); color: white;">Vista
            3D</button>
          <button id="pullBtn">Aggiorna</button>
          <button id="autoBtn" class="ghost">Auto OFF</button>
          <div class="last-update">Ultimo aggiornamento: <span id="lastUpdate">--</span></div>
        </div>
      </div>
    </section>

    <!-- 3D View Container -->
    <div id="container3d"
      style="display: none; width: 100%; height: 600px; border-radius: 26px; box-shadow: var(--shadow); background: #fcfcfc; position: relative; overflow: hidden;">
      <div id="info3d" style="position: absolute; top: 10px; left: 20px; z-index: 10; pointer-events: none;">
        <p style="margin: 0; color: #64748b; font-size: 14px;">Isometric Realtime View</p>
      </div>
    </div>

    <!-- 3D Scripts -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
    </script>

    <script type="module">
      import * as THREE from 'three';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
      import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

      let scene, camera, renderer, labelRenderer, controls;
      let animationId;
      const nodes = {};
      const flows = [];
      let is3DInited = false;

      function init3D() {
        if (is3DInited) return;
        is3DInited = true;

        const container = document.getElementById('container3d');
        const width = container.clientWidth;
        const height = container.clientHeight;

        // Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xfcfcfc);
        scene.fog = new THREE.Fog(0xfcfcfc, 20, 100);

        // Camera
        const aspect = width / height;
        const frustumSize = 40;
        camera = new THREE.OrthographicCamera(
          frustumSize * aspect / -2, frustumSize * aspect / 2,
          frustumSize / 2, frustumSize / -2,
          1, 1000
        );
        camera.position.set(20, 20, 20);
        camera.lookAt(0, 0, 0);

        // Renderers
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(width, height);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(width, height);
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = '0px';
        labelRenderer.domElement.style.pointerEvents = 'none';
        container.appendChild(labelRenderer.domElement);

        // Controls
        controls = new OrbitControls(camera, labelRenderer.domElement);
        controls.enableDamping = true;
        controls.enableZoom = true;
        controls.autoRotate = false;

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Objects
        createWorld();

        // Resize
        window.addEventListener('resize', onWindowResize);

        animate();
      }

      const baseMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.7, metalness: 0.1 });
      const platformMaterial = new THREE.MeshStandardMaterial({ color: 0xf3f4f6, roughness: 0.8 });

      function createPlatform(w, d) {
        const h = 0.5;
        const geom = new THREE.BoxGeometry(w, h, d);
        const mesh = new THREE.Mesh(geom, platformMaterial);
        mesh.position.y = -h / 2;
        mesh.receiveShadow = true;
        return mesh;
      }

      function createNode(id, x, z, label) {
        const group = new THREE.Group();
        group.position.set(x, 0, z);
        group.add(createPlatform(6, 6));

        let mainMesh;
        if (id === 'solar') {
          const panelGeom = new THREE.BoxGeometry(4, 0.2, 3);
          mainMesh = new THREE.Mesh(panelGeom, new THREE.MeshStandardMaterial({ color: 0x2563eb, roughness: 0.2 }));
          mainMesh.rotation.x = -Math.PI / 6;
          mainMesh.position.y = 1.5;
          // Legs
          const l1 = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1.5), baseMaterial); l1.position.set(-1.5, 0.75, -1); group.add(l1);
          const l2 = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1.5), baseMaterial); l2.position.set(1.5, 0.75, -1); group.add(l2);
        } else if (id === 'battery') {
          mainMesh = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 1.5), new THREE.MeshStandardMaterial({ color: 0x10b981 }));
          mainMesh.position.y = 2;
        } else if (id === 'home') {
          mainMesh = new THREE.Mesh(new THREE.BoxGeometry(3, 2.5, 3), baseMaterial); mainMesh.position.y = 1.25;
          const roof = new THREE.Mesh(new THREE.ConeGeometry(2.5, 1.5, 4), new THREE.MeshStandardMaterial({ color: 0x475569 }));
          roof.position.y = 3.25; roof.rotation.y = Math.PI / 4; group.add(roof);
        } else if (id === 'grid') {
          mainMesh = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.5, 5), new THREE.MeshStandardMaterial({ color: 0x64748b })); mainMesh.position.y = 2.5;
          const bar = new THREE.Mesh(new THREE.BoxGeometry(3, 0.2, 0.2), new THREE.MeshStandardMaterial({ color: 0x64748b })); bar.position.y = 4; group.add(bar);
        } else if (id === 'inverter') {
          mainMesh = new THREE.Mesh(new THREE.BoxGeometry(2, 3, 1), new THREE.MeshStandardMaterial({ color: 0xf1f5f9 })); mainMesh.position.y = 1.5;
          const screen = new THREE.Mesh(new THREE.PlaneGeometry(1, 0.5), new THREE.MeshStandardMaterial({ color: 0x000000 })); screen.position.set(0, 2, 0.51); group.add(screen);
        }

        mainMesh.castShadow = true; mainMesh.receiveShadow = true;
        group.add(mainMesh);

        const labelDiv = document.createElement('div');
        labelDiv.style.background = "rgba(255, 255, 255, 0.9)";
        labelDiv.style.padding = "8px 12px";
        labelDiv.style.borderRadius = "12px";
        labelDiv.style.boxShadow = "0 4px 20px rgba(0,0,0,0.08)";
        labelDiv.innerHTML = `
                <div style="font-size: 18px; font-weight: 700; color: #0f172a;" id="3d-val-${id}">--</div>
                <div style="font-size: 12px; font-weight: 600; color: #64748b;" id="3d-unit-${id}">KW</div>
                <div style="font-size: 11px; text-transform: uppercase; color: #94a3b8;">${label}</div>
            `;
        const labelObj = new CSS2DObject(labelDiv);
        labelObj.position.set(0, 5, 0);
        group.add(labelObj);

        scene.add(group);
        nodes[id] = { group };
      }

      function createConnection(fromId, toId) {
        const p1 = nodes[fromId].group.position.clone(); p1.y = 0.5;
        const p2 = nodes[toId].group.position.clone(); p2.y = 0.5;
        const path = new THREE.LineCurve3(p1, p2);
        const tube = new THREE.Mesh(new THREE.TubeGeometry(path, 20, 0.1, 8, false), new THREE.MeshBasicMaterial({ color: 0xe2e8f0, transparent: true, opacity: 0.5 }));
        scene.add(tube);

        const packet = new THREE.Mesh(new THREE.SphereGeometry(0.25), new THREE.MeshBasicMaterial({ color: 0x3b82f6 }));
        packet.visible = false;
        scene.add(packet);

        flows.push({ from: fromId, to: toId, mesh: packet, path: path, progress: 0, active: false, speed: 0.01 });
      }

      function createWorld() {
        createNode('inverter', 0, 0, 'Inverter');
        createNode('solar', -10, -8, 'Solar');
        createNode('battery', 10, -4, 'Battery');
        createNode('home', 5, 8, 'Home');
        createNode('grid', -8, 8, 'Grid');

        createConnection('solar', 'inverter');
        createConnection('inverter', 'battery');
        createConnection('inverter', 'home');
        createConnection('inverter', 'grid');
      }

      function onWindowResize() {
        const container = document.getElementById('container3d');
        if (!container) return; // Ensure container exists before trying to get its dimensions
        const width = container.clientWidth;
        const height = container.clientHeight;
        const aspect = width / height;
        const frustumSize = 40;

        camera.left = -frustumSize * aspect / 2;
        camera.right = frustumSize * aspect / 2;
        camera.top = frustumSize / 2;
        camera.bottom = -frustumSize / 2;

        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
        labelRenderer.setSize(width, height);
      }

      function animate() {
        animationId = requestAnimationFrame(animate); // Store animation ID
        controls.update();

        flows.forEach(f => {
          if (f.active) {
            f.progress += f.speed;
            if (f.progress > 1) f.progress = 0;
            if (f.progress < 0) f.progress = 1;
            f.mesh.position.copy(f.path.getPoint(f.progress));
          }
        });

        renderer.render(scene, camera);
        labelRenderer.render(scene, camera);
      }

      // Export update function to window so main script can call it
      window.update3D = function (data) {
        if (!is3DInited) init3D();

        // Map data to 3D labels
        const invW = data.derived.inverter_power_w || 0;
        const gridW = data.derived.grid_flow_w || 0;
        const battP = data.derived.battery_percent || 0;

        let solarVal = 0;
        if (invW > 0) solarVal = invW;
        if (gridW < 0) solarVal += Math.abs(gridW);
        const load = Math.abs(solarVal + gridW);

        document.getElementById('3d-val-battery').textContent = battP + '%';
        document.getElementById('3d-val-inverter').textContent = invW;
        document.getElementById('3d-val-home').textContent = load.toFixed(0);

        document.getElementById('3d-val-grid').textContent = Math.abs(gridW);
        document.getElementById('3d-unit-grid').textContent = gridW > 0 ? 'W (IMPORT)' : 'W (EXPORT)';

        document.getElementById('3d-val-solar').textContent = solarVal;

        // Flows
        activateFlow('solar', 'inverter', solarVal > 20);
        activateFlow('inverter', 'home', true);
        if (gridW > 0) activateFlow('grid', 'inverter', true); else activateFlow('inverter', 'grid', true);
      };

      function activateFlow(from, to, active) {
        const f = flows.find(x => (x.from === from && x.to === to) || (x.from === to && x.to === from));
        if (f) {
          f.active = active;
          f.mesh.visible = active;
          if (f.from === from) f.speed = 0.02; else f.speed = -0.02;
        }
      }

      window.stop3DAnimation = function () {
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
      };
    </script>

    <details>
      <summary>Dettagli tecnici e registri</summary>
      <div class="details-grid">
        <div class="input-panel">
          <div class="subtitle">Incolla l'output dello script o usa i pulsanti per applicare i dati.</div>
          <textarea id="rawInput" spellcheck="false"></textarea>
          <div class="actions">
            <button id="applyBtn" class="ghost">Applica testo</button>
            <button id="resetBtn" class="ghost">Ripristina esempio</button>
          </div>
          <div class="hint">Suggerimento: mappa il FV con <code>window.SOLAR_REG = 7</code>, la capacita batteria con
            <code>window.BATTERY_KWH = 5.12</code> e la soglia FV con <code>window.SOLAR_START_WM2 = 50</code>.
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Registro</th>
                <th>Valore grezzo</th>
                <th>Interpretazione</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </details>
  </div>

  <script>
    const API_URL = "/data";
    const AUTO_MS = 5000;
    const WEATHER_REFRESH_MS = 15 * 60 * 1000;
    const DEFAULT_BATTERY_KWH = 5.12;

    const sampleRaw = `Reg 0      | 2258
Reg 1      | 41
Reg 2      | 915
Reg 3      | 705
Reg 4      | 700
Reg 7      | 4997
Reg 8      | 29
Reg 9      | 2
Reg 10     | 2
Reg 11     | 1
Reg 19     | 1
Reg 20     | 4145
Reg 21     | 65515
Reg 22     | 64624
Reg 23     | 1
Reg 24     | 16
Reg 27     | 2
Reg 28     | 89
Reg 29     | 561
Reg 32     | 40
Reg 33     | 722
Reg 35     | 64
Reg 36     | 171
Reg 37     | 300
Reg 38     | 12288`;

    const registerHints = {
      0: { name: "Tensione rete (V)", derive: v => `${(v / 10).toFixed(1)} V` },
      2: { name: "Potenza inverter (W)", derive: v => `${signed16(v)} W` },
      21: { name: "Scambio con rete (W)", derive: v => `${signed16(v)} W (import + / export -)` },
      28: { name: "Batteria (%)", derive: v => `${v}%` },
      33: { name: "Tensione batteria (V)", derive: v => `${(v / 10).toFixed(1)} V` }
    };

    const rawInput = document.getElementById("rawInput");
    const tableBody = document.getElementById("tableBody");
    const statusChip = document.getElementById("statusChip");
    const apiStatusEl = document.getElementById("apiStatus");
    const lastUpdateEl = document.getElementById("lastUpdate");
    const applyBtn = document.getElementById("applyBtn");
    const resetBtn = document.getElementById("resetBtn");
    const pullBtn = document.getElementById("pullBtn");
    const autoBtn = document.getElementById("autoBtn");
    const viewToggleBtn = document.getElementById("viewToggleBtn");

    // Elements to toggle
    const flowCard = document.querySelector(".flow-card");
    const detailsEl = document.querySelector("details");
    const container3d = document.getElementById("container3d");

    let is3d = false;

    viewToggleBtn.addEventListener("click", () => {
      is3d = !is3d;
      if (is3d) {
        flowCard.style.display = 'none';
        detailsEl.style.display = 'none';
        container3d.style.display = 'block';
        viewToggleBtn.textContent = "Vista 2D";
        // Trigger resize to fix canvas size if it was hidden
        window.dispatchEvent(new Event('resize'));
      } else {
        flowCard.style.display = 'grid';
        detailsEl.style.display = 'block';
        container3d.style.display = 'none';
        viewToggleBtn.textContent = "Vista 3D";
      }
    });

    const dateLine = document.getElementById("dateLine");
    const tempRange = document.getElementById("tempRange");
    const sunLine = document.getElementById("sunLine");
    const weatherIcon = document.getElementById("weatherIcon");
    const weatherDesc = document.getElementById("weatherDesc");
    const forecastDate1 = document.getElementById("forecastDate1");
    const forecastTemp1 = document.getElementById("forecastTemp1");
    const forecastDate2 = document.getElementById("forecastDate2");
    const forecastTemp2 = document.getElementById("forecastTemp2");

    const solarPowerEl = document.getElementById("solarPower");
    const inverterPowerEl = document.getElementById("inverterPower");
    const batteryPowerEl = document.getElementById("batteryPower");
    const batteryRuntimeEl = document.getElementById("batteryRuntime");
    const batterySunEl = document.getElementById("batterySunWindow");
    const homePowerEl = document.getElementById("homePower");
    const gridPowerEl = document.getElementById("gridPower");
    const gridDirectionEl = document.getElementById("gridDirection");

    const lineSolar = document.getElementById("lineSolar");
    const lineBattery = document.getElementById("lineBattery");
    const lineHome = document.getElementById("lineHome");
    const lineGrid = document.getElementById("lineGrid");
    const lineMeter = document.getElementById("lineMeter");

    const state = {
      auto: false,
      timer: null,
      lastBatteryPercent: null,
      lastLoadW: null,
      solarEtaMinutes: null,
      solarActive: false
    };

    applyBtn.addEventListener("click", () => {
      updateDashboardFromText(rawInput.value.trim());
    });

    resetBtn.addEventListener("click", () => {
      rawInput.value = sampleRaw;
      updateDashboardFromText(sampleRaw);
      setApiStatus(`Mostrati dati di esempio. Avvia l'API su ${API_URL} per i valori live.`);
    });

    pullBtn.addEventListener("click", () => {
      fetchFromApi();
    });

    autoBtn.addEventListener("click", () => {
      toggleAuto();
    });

    function setApiStatus(text, variant = "ok") {
      apiStatusEl.textContent = text;
      apiStatusEl.className = "api-status";
      statusChip.classList.remove("warning", "danger");

      if (variant === "warning") statusChip.classList.add("warning");
      if (variant === "danger") statusChip.classList.add("danger");
    }

    function signed16(val) {
      const n = Number(val) || 0;
      return n > 32767 ? n - 65536 : n;
    }

    function formatPower(value) {
      if (value == null || Number.isNaN(value)) return "--";
      const abs = Math.abs(value);
      if (abs >= 1000) return `${(value / 1000).toFixed(2)} kW`;
      return `${Math.round(value)} W`;
    }

    function formatKw(value) {
      if (value == null || Number.isNaN(value)) return "-- kW";
      return `${(value / 1000).toFixed(2)} kW`;
    }

    function resolveBatteryCapacityWh() {
      const wh = Number(window.BATTERY_WH);
      if (!Number.isNaN(wh) && wh > 0) return wh;
      const kwh = Number(window.BATTERY_KWH);
      if (!Number.isNaN(kwh) && kwh > 0) return kwh * 1000;
      return DEFAULT_BATTERY_KWH * 1000;
    }

    function formatRuntimeMinutes(minutes) {
      if (!Number.isFinite(minutes) || minutes <= 0) return "--";
      const total = Math.round(minutes);
      const h = Math.floor(total / 60);
      const m = total % 60;
      if (h <= 0) return `${m} min`;
      return `${h}h ${String(m).padStart(2, "0")}m`;
    }

    function estimateRuntimeMinutes(batteryPercent, loadW) {
      if (batteryPercent == null || loadW == null) return null;
      const load = Number(loadW);
      if (!Number.isFinite(load)) return null;
      if (load <= 10) return Infinity;
      const capacityWh = resolveBatteryCapacityWh();
      const remainingWh = capacityWh * (batteryPercent / 100);
      return (remainingWh / load) * 60;
    }

    function estimateRuntimeText(batteryPercent, loadW) {
      const minutes = estimateRuntimeMinutes(batteryPercent, loadW);
      if (minutes == null) return "Autonomia: --";
      if (minutes === Infinity) return "Autonomia: standby";
      return `Autonomia: ${formatRuntimeMinutes(minutes)}`;
    }

    function updateBatterySunLine() {
      const runtimeMinutes = estimateRuntimeMinutes(state.lastBatteryPercent, state.lastLoadW);
      if (runtimeMinutes == null) {
        batterySunEl.textContent = "FV: --";
        return;
      }

      if (state.solarActive) {
        batterySunEl.textContent = "FV: attivo";
        return;
      }

      if (!Number.isFinite(state.solarEtaMinutes) || state.solarEtaMinutes == null) {
        batterySunEl.textContent = "FV: dati non disponibili";
        return;
      }

      const etaText = formatRuntimeMinutes(state.solarEtaMinutes);
      const ok = runtimeMinutes === Infinity || runtimeMinutes >= state.solarEtaMinutes;
      batterySunEl.textContent = `FV tra ${etaText} · Autonomia ${ok ? "OK" : "NO"}`;
    }

    function parseRegisters(rawText) {
      const regs = {};
      rawText.split(/\r?\n/).forEach(line => {
        const match = line.match(/Reg\s+(\d+)\s*\|\s*(-?\d+)/i);
        if (match) regs[Number(match[1])] = Number(match[2]);
      });
      return regs;
    }

    function normalizeRegs(raw) {
      const regs = {};
      Object.entries(raw || {}).forEach(([k, v]) => {
        const key = Number(k);
        if (!Number.isNaN(key)) regs[key] = Number(v);
      });
      return regs;
    }

    function formatRegsForTextarea(regs) {
      return Object.keys(regs)
        .map(Number)
        .sort((a, b) => a - b)
        .map(k => `Reg ${k} | ${regs[k]}`)
        .join("\n");
    }

    function deriveMetrics(regs) {
      const solarReg = window.SOLAR_REG;
      return {
        batteryPercent: regs[28],
        inverterPower: regs[2] != null ? signed16(regs[2]) : null,
        gridVoltage: regs[0] != null ? (regs[0] / 10) : null,
        gridFlow: regs[21] != null ? signed16(regs[21]) : null,
        batteryVoltage: regs[33] != null ? (regs[33] / 10) : null,
        solarPower: solarReg != null && regs[solarReg] != null ? regs[solarReg] : null
      };
    }

    function setLineState(line, mode) {
      if (!line) return;
      line.classList.remove("idle", "flow-in", "flow-out");
      line.classList.add(mode);
    }

    function renderMetrics(metrics, ts = Date.now()) {
      const gridFlow = metrics.gridFlow;

      solarPowerEl.textContent = formatPower(metrics.solarPower);
      inverterPowerEl.textContent = formatPower(metrics.inverterPower);
      homePowerEl.textContent = formatPower(metrics.inverterPower);
      gridPowerEl.textContent = gridFlow != null ? formatPower(Math.abs(gridFlow)) : "--";

      const loadW = metrics.inverterPower != null ? Math.max(metrics.inverterPower, 0) : null;

      if (metrics.batteryPercent != null && loadW != null) {
        batteryPowerEl.textContent = `${metrics.batteryPercent}% · ${formatKw(loadW)}`;
      } else if (metrics.batteryPercent != null) {
        batteryPowerEl.textContent = `${metrics.batteryPercent}%`;
      } else if (loadW != null) {
        batteryPowerEl.textContent = formatKw(loadW);
      } else {
        batteryPowerEl.textContent = "--";
      }

      state.lastBatteryPercent = metrics.batteryPercent ?? null;
      state.lastLoadW = loadW;
      batteryRuntimeEl.textContent = estimateRuntimeText(metrics.batteryPercent, loadW);
      updateBatterySunLine();

      if (gridFlow == null) {
        gridDirectionEl.textContent = "Standby";
        statusChip.textContent = "Attesa dati";
        setLineState(lineGrid, "idle");
        setLineState(lineMeter, "idle");
      } else if (gridFlow > 50) {
        gridDirectionEl.textContent = "Import";
        statusChip.textContent = "Prelievo da rete";
        setLineState(lineGrid, "flow-in");
        setLineState(lineMeter, "flow-in");
      } else if (gridFlow < -50) {
        gridDirectionEl.textContent = "Export";
        statusChip.textContent = "Immissione in rete";
        setLineState(lineGrid, "flow-out");
        setLineState(lineMeter, "flow-out");
      } else {
        gridDirectionEl.textContent = "Standby";
        statusChip.textContent = "Quasi zero";
        setLineState(lineGrid, "idle");
        setLineState(lineMeter, "idle");
      }

      setLineState(lineHome, metrics.inverterPower && metrics.inverterPower > 10 ? "flow-in" : "idle");
      setLineState(lineSolar, metrics.solarPower && metrics.solarPower > 10 ? "flow-in" : "idle");
      setLineState(lineBattery, "idle");

      lastUpdateEl.textContent = new Date(ts).toLocaleString("it-IT");
    }

    function renderTable(regs) {
      const rows = Object.keys(regs)
        .map(Number)
        .sort((a, b) => a - b)
        .map(key => {
          const hint = registerHints[key];
          const readable = hint ? hint.derive(regs[key]) : "-";
          const label = hint ? hint.name : "n/d";
          return `
            <tr>
              <td><strong>Reg ${key}</strong></td>
              <td>${regs[key]}</td>
              <td class="label">${label}${readable !== "-" ? ` · ${readable}` : ""}</td>
            </tr>`;
        })
        .join("");

      tableBody.innerHTML = rows || `<tr><td colspan="3" class="label">Nessun registro trovato</td></tr>`;
    }

    function updateDashboardWithRegs(regs, ts) {
      renderMetrics(deriveMetrics(regs), ts);
      renderTable(regs);
    }

    function updateDashboardFromText(rawText) {
      const regs = parseRegisters(rawText);
      updateDashboardWithRegs(regs);
    }

    async function fetchFromApi() {
      setApiStatus(`Lettura da ${API_URL}...`);
      try {
        const res = await fetch(API_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Update 3D View
        if (window.update3D) window.update3D(data);

        const regs = normalizeRegs(data.raw || {});
        const ts = data.meta?.timestamp ? data.meta.timestamp * 1000 : Date.now();
        rawInput.value = formatRegsForTextarea(regs);
        updateDashboardWithRegs(regs, ts);
        const source = data.meta?.source || "API";
        setApiStatus(`Ultima lettura OK (${source}) @ ${new Date(ts).toLocaleTimeString("it-IT")}`);
      } catch (err) {
        statusChip.textContent = "API non disponibile";
        setApiStatus(`Errore API: ${err.message}`, "danger");
      }
    }

    function toggleAuto() {
      state.auto = !state.auto;
      autoBtn.textContent = state.auto ? "Auto ON" : "Auto OFF";
      if (state.auto) {
        fetchFromApi();
        state.timer = setInterval(fetchFromApi, AUTO_MS);
      } else if (state.timer) {
        clearInterval(state.timer);
        state.timer = null;
      }
    }

    function updateDateLine() {
      const now = new Date();
      dateLine.textContent = now.toLocaleString("it-IT", {
        weekday: "short",
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function resolveWeatherCoords() {
      const latOverride = Number(window.WEATHER_LAT);
      const lonOverride = Number(window.WEATHER_LON);
      if (!Number.isNaN(latOverride) && !Number.isNaN(lonOverride)) {
        return Promise.resolve({ lat: latOverride, lon: lonOverride });
      }

      return new Promise(resolve => {
        if (!navigator.geolocation) {
          return resolve({ lat: 45.4642, lon: 9.19 });
        }

        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          () => resolve({ lat: 45.4642, lon: 9.19 }),
          { enableHighAccuracy: false, timeout: 5000, maximumAge: 60 * 60 * 1000 }
        );
      });
    }

    function mapWeatherCode(code) {
      const c = Number(code);
      if (c === 0) return { label: "Sereno", className: "sunny" };
      if ([1, 2, 3].includes(c)) return { label: "Parz. nuvoloso", className: "cloudy" };
      if ([45, 48].includes(c)) return { label: "Nebbia", className: "fog" };
      if ([51, 53, 55].includes(c)) return { label: "Pioviggine", className: "rain" };
      if ([61, 63, 65].includes(c)) return { label: "Pioggia", className: "rain" };
      if ([71, 73, 75, 77].includes(c)) return { label: "Neve", className: "snow" };
      if ([80, 81, 82].includes(c)) return { label: "Rovesci", className: "rain" };
      if ([95, 96, 99].includes(c)) return { label: "Temporale", className: "storm" };
      return { label: "Meteo variabile", className: "cloudy" };
    }

    function formatTemp(value, digits = 1) {
      if (value == null || Number.isNaN(value)) return `--\u00B0C`;
      return `${Number(value).toFixed(digits)}\u00B0C`;
    }

    function formatDateShort(isoDate) {
      if (!isoDate) return "--/--";
      const d = new Date(`${isoDate}T00:00:00`);
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      return `${day}/${month}`;
    }

    function formatTime(value) {
      if (!value) return "--:--";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return "--:--";
      return d.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
    }

    function computeSolarWindow(hourly) {
      const times = hourly?.time || [];
      const radiation = hourly?.shortwave_radiation || [];
      const thresholdOverride = Number(window.SOLAR_START_WM2);
      const threshold = Number.isFinite(thresholdOverride) ? thresholdOverride : 50;
      const now = Date.now();
      let activeNow = false;
      let nextStart = null;

      for (let i = 0; i < times.length; i += 1) {
        const time = new Date(times[i]);
        const rad = Number(radiation[i]);
        if (!Number.isFinite(rad) || Number.isNaN(time.getTime())) continue;
        const ts = time.getTime();
        if (ts <= now && rad >= threshold) activeNow = true;
        if (ts > now && rad >= threshold) {
          nextStart = ts;
          break;
        }
      }

      const etaMinutes = nextStart != null ? (nextStart - now) / 60000 : null;
      return { activeNow, etaMinutes, threshold };
    }

    async function fetchWeather() {
      const coords = await resolveWeatherCoords();
      const url = new URL("https://api.open-meteo.com/v1/forecast");
      url.searchParams.set("latitude", coords.lat);
      url.searchParams.set("longitude", coords.lon);
      url.searchParams.set("current", "temperature_2m,weather_code");
      url.searchParams.set("daily", "temperature_2m_min,temperature_2m_max,weather_code,sunrise,sunset");
      url.searchParams.set("hourly", "shortwave_radiation");
      url.searchParams.set("timezone", "auto");
      url.searchParams.set("forecast_days", "3");

      const res = await fetch(url.toString(), { cache: "no-store" });
      if (!res.ok) throw new Error(`Meteo HTTP ${res.status}`);
      return res.json();
    }

    async function updateWeather() {
      try {
        const data = await fetchWeather();
        const daily = data.daily || {};
        const tempMin = daily.temperature_2m_min?.[0];
        const tempMax = daily.temperature_2m_max?.[0];
        const weatherCode = data.current?.weather_code ?? daily.weather_code?.[0];
        const sunrise = daily.sunrise?.[0];
        const sunset = daily.sunset?.[0];
        const solarWindow = computeSolarWindow(data.hourly);

        tempRange.textContent = `${formatTemp(tempMin)} - ${formatTemp(tempMax)}`;
        sunLine.textContent = `Alba ${formatTime(sunrise)} · Tramonto ${formatTime(sunset)}`;

        const weather = mapWeatherCode(weatherCode);
        weatherDesc.textContent = weather.label;
        weatherIcon.className = `weather-icon ${weather.className}`;

        state.solarActive = solarWindow.activeNow;
        state.solarEtaMinutes = solarWindow.etaMinutes;
        updateBatterySunLine();

        forecastDate1.textContent = formatDateShort(daily.time?.[1]);
        forecastTemp1.textContent = formatTemp(daily.temperature_2m_max?.[1], 0);
        forecastDate2.textContent = formatDateShort(daily.time?.[2]);
        forecastTemp2.textContent = formatTemp(daily.temperature_2m_max?.[2], 0);
      } catch (err) {
        weatherDesc.textContent = "Meteo non disponibile";
        sunLine.textContent = "Alba --:-- · Tramonto --:--";
        state.solarActive = false;
        state.solarEtaMinutes = null;
        updateBatterySunLine();
      }
    }

    // Bootstrap with sample data.
    rawInput.value = sampleRaw;
    updateDashboardFromText(sampleRaw);
    setApiStatus(`Mostrati dati di esempio. Avvia l'API su ${API_URL} per i valori live.`);
    updateDateLine();
    setInterval(updateDateLine, 60000);
    toggleAuto();
    updateWeather();
    setInterval(updateWeather, WEATHER_REFRESH_MS);
  </script>
</body>

</html>